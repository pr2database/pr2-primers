---
author: "Daniel Vaulot"
date: '`r format(Sys.time(), "%d %m %Y")`'
header-includes:
   - \usepackage{color, fancyvrb}
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: yes
    toc_depth: 3
    number_sections : yes
  pdf_document: 
    toc: yes
    toc_depth: 3
    number_sections : yes
  rmdformats::readthedown:
    highlight: kate
    number_sections : yes    
---

```{r eval=FALSE, echo=FALSE, message=FALSE, cache=FALSE}
# Use this command to render the file
rmarkdown::render('PR2 Primer_Set.Rmd', 
                  output_file = '../../../Web site/vaulot.github.io/pr2/PR2_Primer_Set_84_mismatches_2.html', 
                  output_format="rmdformats::readthedown")
```

# Constants

```{r}
  
  max_mismatch = 2
  primer_set_id_selected = 84

  gene_selected = "18S_rRNA"  # Can be 18S_rRNA or 16_rRNA

  # rda_file_label = "_set_32"  # This label is added at the end of the rda file name
  # one_primer_set = "32 - V6-V8 - Wilkins 2013"
    
  # rda_file_label = "_set_83"  # This label is added at the end of the rda file name
  # one_primer_set = "83 - V4 - Wenshu"
  
  rda_file_label = str_c("_set_", primer_set_id_selected)  # This label is added at the end of the rda file name
  primer_set_label = str_c(primer_set_id_selected, " - V3 - Sisson 2018 - SAR")

  sequence_length_min = 1500
  
  # To plot the distribution
  
  xmin = 150
  xmax = 200
  xmax2 = 2000
```


# Set up files and title name
```{r}
  file_head = stringr::str_c("output/pr2_match_", gene_selected , rda_file_label, "_mismatches_", max_mismatch)
  file_name_rda  = stringr::str_c(file_head, ".rda")
  file_name_summary = stringr::str_c(file_head, ".xlsx")
  
  title = stringr::str_c("Primer set #", primer_set_label)
```

---
title: "`r title`"
---

# Initialize
Load the variables common to the different scripts and the necessary libraries

```{r init, eval=TRUE, message=FALSE, warning=FALSE, echo=FALSE}

# Libraries tidyr ---------------------------------------------------------

  library("ggplot2") 
  library("dplyr")   
  library("readxl")
  library("tibble")
  library("readr")
  library("purrr")
  library("forcats")
  library("lubridate")
  library("stringr")

# Libraries dvutils and pr2database -------------------------------------------------------
  if(any(grepl("package:dvutils", search()))) detach("package:dvutils", unload=TRUE)
  library("dvutils")

# Options for knitting the report -------------  
  
  library(knitr)
  library(rmdformats)
  library(kableExtra) 

  knitr::opts_chunk$set(fig.width=6, 
                        fig.height=6, 
                        eval=TRUE, 
                        cache=TRUE,
                        echo=TRUE,
                        prompt=FALSE,
                        tidy=TRUE,
                        comment=NA,
                        message=FALSE,
                        warning=FALSE)
  opts_knit$set(width=90)
  options(max.print="500")  
  options(knitr.kable.NA = '')
```

## Build the primer set table
```{r}

# Read from local database
pr2_db <- db_info("pr2_local")
pr2_db_con <- db_connect(pr2_db)
primers <- tbl(pr2_db_con, "pr2_primers") %>% collect()
primer_sets_all <- tbl(pr2_db_con, "pr2_primer_sets") %>% collect()
disconnect <- db_disconnect(pr2_db_con)

  primer_sets <- primer_sets_all %>% 
  filter(primer_set_id == primer_set_id_selected)
         
primer_sets <- primer_sets %>% 
  left_join(select(primers, 
                   primer_id, 
                   fwd_name=name,
                   fwd_seq=sequence, 
                   fwd_start_yeast= start_yeast, 
                   fwd_end_yeast= end_yeast), 
            by = c("fwd_id" = "primer_id")) %>% 
  left_join(select(primers, 
                 primer_id, 
                 rev_name=name,
                 rev_seq=sequence, 
                 rev_start_yeast= start_yeast, 
                 rev_end_yeast= end_yeast), 
          by = c("rev_id" = "primer_id")) %>% 
  mutate(length_yeast = rev_end_yeast - fwd_start_yeast + 1) %>% 
  select(gene_region, specificity, primer_set_id,primer_set_name, contains("fwd"), contains("rev"),length_yeast, used_in:remark) %>% 
  arrange(gene_region,  fwd_start_yeast)

# write_tsv(primer_sets, path = "output/primers_Table_1.tsv", na = "")



knitr::kable(select(primer_sets,primer_set_id:primer_set_name, fwd_name, fwd_seq, rev_name, rev_seq, length_yeast)) %>%
  kableExtra::kable_styling()
       
```

# Load the data file

This avoids recomputing each time.

All sequences for which introns have been removed are filtered out (contain "_UC" in pr2_accession)

```{r load_matches}

  load(file=file_name_rda)

  print(str_c("Before filtration: ", nrow(pr2_match_final)))

  pr2_match_final_filtered <- pr2_match_final %>% 
    # Remove sequences for which the introns have been removed
      filter(! str_detect(pr2_accession, "_UC")) %>% 
    # Remove sequence that are shorter
      filter(sequence_length>= sequence_length_min)
    

  print(str_c("After filtration: ", nrow(pr2_match_final_filtered)))

  
# The next lines are not nessary because this was done during the calculation....
  # pr2_match_final <-  pr2_match_final %>% 
  #   filter(gene_region %in% regions) 
  # 
    

```

# Summarize the data in tables

## Summarize all eukaryotes

```{r summary_euks}

  pr2_match_summary_primer_set <- pr2_match_final_filtered  %>% 
                      group_by(gene_region, primer_label, primer_set_id ) %>% 
                      summarize (pct_fwd = sum(!is.na(fwd_pos))/n()*100,
                                 pct_rev = sum(!is.na(rev_pos))/n()*100,
                                 pct_amplicons = sum(!is.na(ampli_size))/n()*100, 
                                 ampli_size_mean = mean(ampli_size, na.rm=TRUE),
                                 ampli_size_sd = sd(ampli_size, na.rm=TRUE),
                                 ampli_size_max = max(ampli_size, na.rm=TRUE),
                                 ampli_size_min = min(ampli_size, na.rm=TRUE),
                                 n_seq = n())  
 
  # write_tsv(pr2_match_summary_primer_set, str_c("pr2_match_summary_primer_set_",gene_selected,".tsv"), na="")
  
# Long form for Number of sequences
  
  # This dataframe is used to re-order the bars correctly
  pct_category_order <- data.frame(pct_category = c("pct_amplicons","pct_fwd","pct_rev"), pct_category_order = c(3, 1, 2))
  
  pr2_match_summary_primer_set_long <- pr2_match_summary_primer_set %>% 
    tidyr::gather("pct_category", "pct_seq", pct_fwd:pct_amplicons) %>% 
    left_join(pct_category_order)
  
  
```

## Summarize per supergroup

```{r summary_supergroups, warning=FALSE}

  pr2_match_summary_primer_set_sg <- pr2_match_final_filtered  %>% 
                      group_by(supergroup, gene_region, primer_label, primer_set_id) %>% 
                      summarize (pct_fwd = sum(!is.na(fwd_pos))/n()*100,
                                 pct_rev = sum(!is.na(rev_pos))/n()*100,
                                 pct_amplicons = sum(!is.na(ampli_size))/n()*100, 
                                 ampli_size_mean = case_when (pct_amplicons>0 ~ mean(ampli_size, na.rm=TRUE)),
                                 ampli_size_sd = case_when (pct_amplicons>0 ~ sd(ampli_size, na.rm=TRUE)),
                                 ampli_size_max = case_when (pct_amplicons>0 ~ max(ampli_size, na.rm=TRUE)),
                                 ampli_size_min = case_when (pct_amplicons>0 ~ min(ampli_size, na.rm=TRUE)),
                                 n_seq = n())  %>% 
                      ungroup()
 

  # write_tsv( pr2_match_summary_primer_set_sg, str_c("pr2_match_summary_primer_set_",gene_selected,"_per_sg.tsv"), na="")
  
```

## Summarize per class 

```{r summary_class, warning=FALSE}

  pr2_match_summary_primer_set_class <- pr2_match_final_filtered %>% 
                      group_by(supergroup, division, class, gene_region, primer_label, primer_set_id) %>% 
                      summarize (pct_fwd = sum(!is.na(fwd_pos))/n()*100,
                                 pct_rev = sum(!is.na(rev_pos))/n()*100,
                                 pct_amplicons = sum(!is.na(ampli_size))/n()*100, 
                                 ampli_size_mean = case_when (pct_amplicons>0 ~ mean(ampli_size, na.rm=TRUE)),
                                 ampli_size_sd = case_when (pct_amplicons>0 ~ sd(ampli_size, na.rm=TRUE)),
                                 ampli_size_max = case_when (pct_amplicons>0 ~ max(ampli_size, na.rm=TRUE)),
                                 ampli_size_min = case_when (pct_amplicons>0 ~ min(ampli_size, na.rm=TRUE)),
                                 n_seq = n())  
 
  # write_tsv(pr2_match_summary_primer_set_class, str_c("pr2_match_summary_primer_set_",gene_selected,"_per_class.tsv"), na="")  
  
```

## Write up the data
```{r}
 onglets <- list("global" =pr2_match_summary_primer_set, 
                 "supergroup" = pr2_match_summary_primer_set_sg,
                 "class" = pr2_match_summary_primer_set_class)

 openxlsx::write.xlsx(onglets,file_name_summary)
```
# Percent of sequences amplified

# Amplicon length

## Average size 

```{r amplicon_length_average}
  g <- ggplot(pr2_match_summary_primer_set_long) + 
    geom_col(aes(x=reorder(primer_label, primer_set_id), y=pct_seq, 
                 fill=fct_reorder(pct_category, pct_category_order)), width=.7, position = "dodge") +
    theme_bw() +
    xlab("Primer set") + ylab("% of sequences amplified") + 
    scale_fill_manual(name = "% amplified",  values = c("pct_amplicons" = "black", "pct_fwd" = "blue","pct_rev" = "red"), 
                      labels=c( "Primer fwd", "Primer rev", "Amplicons")) +
    ggtitle (str_c("Set -", primer_set_label," - Max mismatches: ", max_mismatch))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(g)
  
  ggplot(pr2_match_final, aes(x= primer_label, y=ampli_size, group=primer_set_id)) + 
    geom_boxplot(outlier.alpha = 0.3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("Primer set") +
    ggtitle (str_c("Set -", primer_set_label," - Max mismatches: ", max_mismatch))

```

## Amplicon distribution

```{r amplicon_length_histogram}



  pr2_match_final_one <- pr2_match_final %>% 
    filter( !(supergroup %in% c("Apusozoa", "Eukaryota_X", "Protalveolata") ))
    
  primer_label <- str_replace_all(pr2_match_final_one$primer_label[1], "_", " ")
  
  g <- ggplot(pr2_match_final_one, aes(x= ampli_size)) + 
    geom_density(fill="blue", alpha=0.9) +
    xlab("Amplicon size") +
    ggtitle(str_c("Primer set: ", primer_set_label, " - Max mismatches: ", max_mismatch)) +
    xlim(xmin,xmax)
  
  print(g)
  
  fig3A <- ggplot(pr2_match_final_one, aes(x= ampli_size, fill=supergroup)) + 
    geom_density(alpha=0.9)+
    theme_bw() +
    theme(legend.position = "none") +
    scale_fill_viridis_d(option = "inferno") +
    xlab("Amplicon size (bp)") + ylab("Density") +
    ggtitle(str_c("Primer set: ", primer_set_label, " - Max mismatches: ", max_mismatch)) +
    xlim(xmin,xmax) 
  
  print(fig3A)

  fig3B <- ggplot(pr2_match_final_one, aes(x= supergroup, y=ampli_size)) + 
    geom_boxplot(outlier.alpha = 0.3)+
    theme_bw() +
    coord_flip()+
    # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("Supergroup") + ylab("Amplicon size (bp)") +
    ylim(0,xmax2)
    
  print(fig3B)
  
  g <- ggplot(pr2_match_final_one, aes(x= supergroup, y=ampli_size)) + 
    geom_violin() +
    coord_flip()+
    # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("Supergroup") + ylab("Amplicon size (bp)") 
  print(g)
    

```

## Plot an example of amplicon size distribution


```{r graph_set_4}



  pr2_match_summary_filtered <- pr2_match_summary_primer_set_sg %>% 
    filter((n_seq > 20) & 
           !(supergroup %in% c("Apusozoa", "Eukaryota_X") ))
  

  
 fig3C <- ggplot(pr2_match_summary_filtered) + 
    geom_col(data=pr2_match_summary_filtered, 
             aes(x=str_c(supergroup, " - n = ", n_seq), 
                 y=pct_amplicons, 
                 fill=supergroup),  
                 position="dodge") +
    theme_bw()+
    theme(legend.position = "none") +
    scale_fill_viridis_d(option = "inferno") +
    coord_flip() + 
    ylab("% of sequences amplified") + xlab("") # +
    # ggtitle (str_c("Set - ", primer_set_label, " - % amplified per Supergroup") ) 

  print(fig3C)  
  
  g <- ggplot(filter(pr2_match_summary_filtered, !is.nan(ampli_size_mean))) + 
    geom_point(aes(x=str_c(supergroup, " - n = ", n_seq), 
                   y=ampli_size_mean), 
               colour="black") +
    coord_flip()  +
    geom_errorbar(aes(x=str_c(supergroup, " - n = ", n_seq), 
                      ymax=ampli_size_mean + ampli_size_sd, 
                      ymin=ampli_size_mean - ampli_size_sd)) +
    xlab("Supergroup") + ylab("Amplicon size (bp)")   # +
    # scale_y_continuous(breaks = (1:8)*200, limits = c(0,1500)) +
    # ggtitle (str_c("Set - ", primer_set_label, 
    #                " - Amplicon sizes") )  +
    # geom_hline(yintercept = c(450,550) , linetype= 2)

  print(g)


```

## Synthetic Figure

```{r,  fig.height=6, fig.width=18}

# g.fig3A <- ggplotGrob(fig3A) # convert to gtable
# g.fig3B <- ggplotGrob(fig3B) # convert to gtable
# 
# fig3A.widths <- g.fig3A$widths[1:3] # extract the first three widths, 
#                                   # corresponding to left margin, y lab, and y axis
# fig3B.widths <- g.fig3B$widths[1:3] # same for mpg plot
# max.widths <- grid::unit.pmax(fig3A.widths, fig3B.widths) # calculate maximum widths
# g.fig3A$widths[1:3] <- max.widths # assign max. widths to iris gtable
# g.fig3B$widths[1:3] <- max.widths # assign max widths to mpg gtable

cowplot::plot_grid(fig3A, fig3B, fig3C, ncol = 3, nrow = 1, align = "h")

```


# Classes


## Autotrophs


```{r graph_autotrophs}

  pr2_match_summary_filtered <- filter(pr2_match_summary_primer_set_class,
                                      (n_seq > 20) &
                                      (division %in% c("Haptophyta", "Dinoflagellata", 
                                                       "Chlorophyta", "Ochrophyta", "Cryptophyta")))
  
  if(nrow(pr2_match_summary_filtered) > 0 ) {
  
  g <- ggplot(pr2_match_summary_filtered) + 
    geom_col(data=pr2_match_summary_filtered, 
             aes(x=str_c(division, "-", class), 
                 y=pct_amplicons),  
             fill="grey", position="dodge") +
    theme_bw() +
    coord_flip() + 
    ylab("% of sequences amplified") + xlab("Class")  +
    ggtitle (str_c("Set ", primer_set_label, " - Classes") )  +
    facet_wrap(~ primer_label, scales ="fixed")

  print(g)
  
g <- ggplot(filter(pr2_match_summary_filtered, !is.nan(ampli_size_mean))) + 
    geom_point(aes(x=str_c(division, "-", class), 
                   y=ampli_size_mean), 
               colour="black") +
    theme_bw() +
    coord_flip()  +
    geom_errorbar(aes(x=str_c(division , "-", class), 
                      ymax=ampli_size_mean + ampli_size_sd, 
                      ymin=ampli_size_mean - ampli_size_sd)) +
    xlab("Class") + ylab("Amplicon size (bp)")  +
    # scale_y_continuous(breaks = (1:8)*200, limits = c(0,1500)) +
    ggtitle (str_c("Set ", primer_set_label, 
                   " - Classes") ) +
    geom_hline(yintercept = c(450,550) , linetype= 2) +
    facet_wrap(~ primer_label, scales ="fixed")

  print(g)
  }
```

## Rhizaria


```{r graph_rhizaria}

  pr2_match_summary_filtered <- filter(pr2_match_summary_primer_set_class,
                                      (n_seq > 20) &
                                      (supergroup %in% c("Rhizaria")))
  
  if(nrow(pr2_match_summary_filtered) > 0 ) {
  
  g <- ggplot(pr2_match_summary_filtered) + 
    geom_col(data=pr2_match_summary_filtered, 
             aes(x=str_c(division, "-", class), 
                 y=pct_amplicons),  
             fill="grey", position="dodge") +
    theme_bw() +
    coord_flip() + 
    ylab("% of sequences amplified") + xlab("Class")  +
    ggtitle (str_c("Set ", primer_set_label, " - Classes") )  +
    facet_wrap(~ primer_label, scales ="fixed")

  print(g)
  
g <- ggplot(filter(pr2_match_summary_filtered, !is.nan(ampli_size_mean))) + 
    geom_point(aes(x=str_c(division, "-", class), 
                   y=ampli_size_mean), 
               colour="black") +
    theme_bw() +
    coord_flip()  +
    geom_errorbar(aes(x=str_c(division,  "-", class), 
                      ymax=ampli_size_mean + ampli_size_sd, 
                      ymin=ampli_size_mean - ampli_size_sd)) +
    xlab("Class") + ylab("Amplicon size (bp)")  +
    # scale_y_continuous(breaks = (1:8)*200, limits = c(0,1500)) +
    ggtitle (str_c("Set ", primer_set_label, 
                   " - Classes") ) +
    geom_hline(yintercept = c(450,550) , linetype= 2) +
    facet_wrap(~ primer_label, scales ="fixed")

  print(g)
  }
```

## Opisthokonta


```{r graph_opistho}


  pr2_match_summary_filtered <- filter(pr2_match_summary_primer_set_class,
                                      (n_seq > 20) &
                                      (supergroup %in% c("Opisthokonta")) )
  
  g <- ggplot(pr2_match_summary_filtered) + 
    geom_col(data=pr2_match_summary_filtered, 
             aes(x=str_c(division, "-", class, " - n= ", n_seq), 
                 y=pct_amplicons),  
             fill="grey", position="dodge") +
    theme_bw() +
    coord_flip() + 
    ylab("% of sequences amplified") + xlab("Class")  +
    ggtitle (str_c("Set ", primer_set_label, " - Classes") ) 

  print(g)  
  
  g <- ggplot(filter(pr2_match_summary_filtered, !is.nan(ampli_size_mean))) + 
    geom_point(aes(x=str_c(division, "-", class, " - n= ", n_seq), 
                   y=ampli_size_mean), 
               colour="black") +
    coord_flip()  +
    geom_errorbar(aes(x=str_c(division, "-", class, " - n= ", n_seq), 
                      ymax=ampli_size_mean + ampli_size_sd, 
                      ymin=ampli_size_mean - ampli_size_sd)) +
    xlab("Class") + ylab("Amplicon size (bp)")  +
    # scale_y_continuous(breaks = (1:8)*200, limits = c(0,1500)) +
    ggtitle (str_c("Set ", primer_set_label, 
                   " - Classes") ) +
    geom_hline(yintercept = c(450,550) , linetype= 2)

  print(g)

```

